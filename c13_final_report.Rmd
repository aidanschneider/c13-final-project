---
title: "c13-project: Data Science Final Project"
authors: "Aidan Schneider, Amir Osorio, Danny Kennen"
output:
  github_document:
    toc: true
---

```{r setup}
library(tidyverse)
library(dplyr)
```

# Intro

# Background and Data

# EDA and Analysis of Data 

### Import data files

```{r}
# import child mortality csv
df_child_mortality <- read_csv("./data_files/child_mortality_0_5_year_olds_dying_per_1000_born.csv")

# " daily income csv
df_daily_income <- read_csv("./data_files/mincpcap_cppp.csv")

# " life expectancy at birth csv
df_life_expectancy <- read_csv("./data_files/life_exp.csv")

# " population growth csv
df_pop_growth <- read_csv("./data_files/population_growth_annual_percent.csv")

# " fertility csv
df_fertility <- read_csv("./data_files/children_per_woman_total_fertility.csv")

# " c02 emissions csv
df_co2emissions <- read_csv("./data_files/co2_pcap_cons.csv")

# " population csv
df_population <- read_csv("./data_files/pop.csv")

# " GDP-per-capital csv
df_gdp_percap <- read_csv("./data_files/gdp_pcap.csv")
```

## Metrics



-   child mortality
-   daily income
-   GDP-per-capita
-   life expectancy at birth
-   population growth
-   fertility
-   c02 emissions
-   population


## EDA

To begin our analysis of the data, we first perform EDA to get a general idea for the shape of the overall data. We decided to look at the full timescale for each of these datasets to determine key inflection points that could be attributed to the transition from communism to capitalism that we are interested in. Our full EDA analysis can be found in 

### Population Growth

```{r}

df_pop_g <- df_pop_growth %>% 
  pivot_longer(
    cols = -country,
    names_to = "year",
    values_to = "population"
  ) %>%
  mutate(
    population_numeric = case_when(
      str_detect(population, "k") ~ as.numeric(str_replace(population, "k", "")) * 1e3,
      str_detect(population, "M") ~ as.numeric(str_replace(population, "M", "")) * 1e6,
      str_detect(population, "B") ~ as.numeric(str_replace(population, "B", "")) * 1e9,
      TRUE ~ as.numeric(population)
    )
  ) %>% 
  filter(as.numeric(year) <= 2025)

df_growth <- df_pop_g %>% 
  filter(country %in% c("Armenia", "Azerbaijan", "Belarus", "Estonia", "Georgia", "Kazakhstan", "Kyrgyzstan", "Latvia", "Lithuania", "Moldova", "Russia", "Tajikistan", "Turkmenistan", "Ukraine", "Uzbekistan", "Serbia", "Croatia", "Bosnia and Herzegovina", "Slovenia", "Montenegro", "North Macedonia", "Albania", "Bulgaria", "Romania", "Poland", "Czechia", "Slovakia", "Hungary")) 

df_growth %>% 
  ggplot(aes(x = as.numeric(year), y = population_numeric)) +
  geom_line(aes(color = country)) +
  geom_smooth(method = "loess", color = "black", se = TRUE) +
  labs(
    title = "Population Growth of Post-Communist Countries",
    x = "Year",
    y = "Population"
  )


```

In this plot, our data had a lot of gaps and began in 1960. Despit this we were able to determine a key inflection point around 1980-2005 where population growth stagnates. 


### GDP-Per-Capita

```{r}
df_gdp <- df_gdp_percap %>%
  pivot_longer(
    cols = -country,
    names_to = "year",
    values_to = "gdp",
    values_transform = list(gdp = as.numeric)  # Ensure all values are numeric
  ) %>%
  mutate(year = as.numeric(year))

df_gdp_comm <- df_gdp %>% 
  filter(country %in% c("Armenia", "Azerbaijan", "Belarus", "Estonia", "Georgia", "Kazakhstan", "Kyrgyzstan", "Latvia", "Lithuania", "Moldova", "Russia", "Tajikistan", "Turkmenistan", "Ukraine", "Uzbekistan", "Serbia", "Croatia", "Bosnia and Herzegovina", "Slovenia", "Montenegro", "North Macedonia", "Albania", "Bulgaria", "Romania", "Poland", "Germany", "Czechia", "Slovakia", "Hungary")) %>%
  filter (year <= 2025)
  
df_gdp_comm %>% 
  ggplot(aes(x = year, y = gdp)) +
  geom_line(aes(color = country)) +  
  geom_smooth(method = "loess", color = "black", se = TRUE) +
  labs(
    title = "GDP Change Post-Communist Countries",
    x = "Year",
    y = "GDP"
  )
```


### Child Mortality 

```{r}
# data for the fact wrap

# Child mortality 
df_c_mortality <- df_child_mortality %>% 
   pivot_longer(
    cols = -country,
    names_to = "year",
    values_to = "mortality_numbers"
  ) %>% 
  mutate(year = as.numeric(year)) 

df_mortality <- df_c_mortality %>%
  filter(country %in% countries) %>% 
  filter(year <= 2025)

df_mortality %>%
  mutate(year = as.numeric(year)) %>%
  ggplot(aes(x = year, y = mortality_numbers)) +
  geom_line(aes(color = country))+
  geom_smooth(aes(group = 1, color = NULL), 
              method = "loess",
              color = "black", 
              size = 1.2,
              span = 0.3, 
              alpha = 0.5) 
```

### Fertility

```{r}
# Fertility 
df_fert <- df_fertility %>% 
   pivot_longer(
    cols = -country,
    names_to = "year",
    values_to = "fertility_numbers"
  ) %>% 
  mutate(year = as.numeric(year)) 

df_fert_clean <- df_fert %>%
  filter(country %in% countries) %>% 
  filter(year <= 2025)

df_fert_clean %>%
  mutate(year = as.numeric(year)) %>%
  ggplot(aes(x = year, y = fertility_numbers)) +
  geom_line(aes(color = country)) +
  geom_smooth(aes(group = 1, color = NULL), 
              method = "loess",
              color = "black", 
              size = 1.2,
              span = 0.3, 
              alpha = 0.5) 
```

### CO2 Emissions

```{r}
# co2 emmisions
df_co2_emm <- df_co2emissions %>%
  pivot_longer(
    cols = -country,
    names_to = "year",
    values_to = "emm",
    values_transform = list(emm = as.numeric)  # Ensure all values are numeric
  ) %>%
  mutate(year = as.numeric(year))  # Convert year to numeric
df_co2_emm_clean <- df_co2_emm %>%
  filter(country %in% countries) %>%
  filter(year <= 2025)

df_co2_emm_clean %>%
  ggplot(aes(x = year, y = emm))+
  geom_line(aes(color = country))+
  geom_smooth(aes(group = 1, color = NULL), 
              method = "loess",
              color = "black", 
              size = 1.2,
              span = 0.3, 
              alpha = 0.5)
```

```{r}
# Population
df_pop <- df_population %>% 
  pivot_longer(
    cols = -country,
    names_to = "year",
    values_to = "population"
  ) %>%
  mutate(
    population_numeric = case_when(
      str_detect(population, "k") ~ as.numeric(str_replace(population, "k", "")) * 1e3,
      str_detect(population, "M") ~ as.numeric(str_replace(population, "M", "")) * 1e6,
      str_detect(population, "B") ~ as.numeric(str_replace(population, "B", "")) * 1e9,
      TRUE ~ as.numeric(population)
    )
  ) %>% 
  
  filter(year <= 2025)

df_albania <- df_pop %>% 
  filter(country %in% countries) 

df_albania %>% 
  ggplot(aes(x = as.numeric(year), y = population_numeric, color = country)) +
  geom_line() +
  geom_smooth(aes(group = 1, color = NULL), 
              method = "loess",
              color = "black", 
              size = 1.2,
              span = 0.3, 
              alpha = 0.5) + 
  scale_y_log10()
```

```{r}
# Income
df_daily <- df_daily_income %>% 
   pivot_longer(
    cols = -country,
    names_to = "year",
    values_to = "income_perp"
  ) %>% 
  filter(as.numeric(year) <= 2025)
df_incomed <- df_daily %>% 
  filter(country %in% countries)
  
df_incomed %>% 
  ggplot(aes(x = as.numeric(year), y = income_perp, color = country)) +
  geom_line() +
  geom_smooth(aes(group = 1, color = NULL), 
              method = "loess",
              color = "black", 
              size = 1.2,
              span = 0.3, 
              alpha = 0.5)
```

### Life Expectancy 

```{r}
# Life expectancy 
df_life_exp <- df_life_expectancy %>% 
   pivot_longer(
    cols = -country,
    names_to = "year",
    values_to = "life_exp"
  ) %>% 
  filter(as.numeric(year) <= 2025)
df_lifeexp <- df_life_exp %>% 
  filter(country %in% countries)
df_lifeexp %>% 
  ggplot(aes(x = as.numeric(year), y = life_exp, color = country)) +
  geom_line() +
  geom_smooth(aes(group = 1, color = NULL), 
              method = "loess",
              color = "black", 
              size = 1.2,
              span = 0.3, 
              alpha = 0.5)
```

```{r}
df_gdp_tidy <- df_gdp_comm %>%
  mutate(year = as.numeric(year)) %>%
  select(country, year, value = gdp) %>%
  mutate(metric = "GDP per capita")

df_popg_tidy <- df_growth %>%
  mutate(year = as.numeric(year)) %>%
  select(country, year, value = population_numeric) %>%
  mutate(metric = "Population Growth")

df_childm_tidy <- df_mortality %>%
  mutate(year = as.numeric(year)) %>%
  select(country, year, value = mortality_numbers) %>%
  mutate(metric = "Child Mortality")

df_fertility_tidy <- df_fert_clean %>%
  mutate(year = as.numeric(year)) %>%
  select(country, year, value = fertility_numbers) %>%
  mutate(metric = "Fertility")

df_co2_tidy <- df_co2_emm_clean %>%
  mutate(year = as.numeric(year)) %>%
  select(country, year, value = emm) %>%
  mutate(metric = "co2 Emissions")

df_population_tidy <- df_albania %>%
  mutate(year = as.numeric(year)) %>%
  select(country, year, value = population_numeric) %>%
  mutate(metric = "Population") 

df_income_tidy <- df_incomed %>%
  mutate(year = as.numeric(year)) %>%
  select(country, year, value = income_perp) %>%
  mutate(metric = "Income") 

df_lifeexp_tidy <- df_lifeexp %>%
  mutate(year = as.numeric(year)) %>%
  select(country, year, value = life_exp) %>%
  mutate(metric = "Life Expectance") 

# Combination of plots
df_combined <- bind_rows(df_gdp_tidy, df_popg_tidy, df_childm_tidy, df_fertility_tidy, df_co2_tidy, df_population_tidy, df_income_tidy, df_lifeexp_tidy)

#Filter time range
df_combined_filtered <- df_combined %>%
  filter(year >= 1980, year <= 2005)
# Plot
ggplot(df_combined_filtered, aes(x = year, y = value)) +
  geom_line(aes(group = country), color = "gray80", alpha = 0.3) +  
  geom_smooth(color = "brown", se = TRUE, method = "loess") +       
  facet_wrap(~ metric, scales = "free_y") +                       
  labs(x = "Year", y = NULL, title = "Trends from 1990 - 2005")
```


# Quantification of Error

```{r}
convert_to_numeric <- function(x) {
  if (is.numeric(x)) return(x)
  
  # convert "k" to thousands, "M" to millions and so on
  case_when(
    str_detect(x, "k$") ~ as.numeric(str_replace(x, "k$", "")) * 1e3,
    str_detect(x, "M$") ~ as.numeric(str_replace(x, "M$", "")) * 1e6,
    str_detect(x, "B$") ~ as.numeric(str_replace(x, "B$", "")) * 1e9,
    TRUE ~ suppressWarnings(as.numeric(x))
  )
}


plot_relative_se <- function(df, title_prefix) {
  # converting all column names to character
  df <- df %>% mutate(across(everything(), as.character))
  
  # Pivot and calculate RSE
  df_long <- df %>%
    pivot_longer(
      cols = -country,
      names_to = "year",
      values_to = "value"
    ) %>%
    filter(country %in% countries) %>%
    filter(as.numeric(year) <= 2005 & as.numeric(year) >= 1980) %>% 
  
    mutate(value_numeric = sapply(value, convert_to_numeric)) %>%

    group_by(year) %>%
    summarize(
      mean_value = mean(value_numeric, na.rm = TRUE),
      std_dev = sd(value_numeric, na.rm = TRUE),
      n_countries = sum(!is.na(value_numeric)),
      standard_error = std_dev / sqrt(n_countries),
      relative_se = if_else(
        abs(mean_value) > 0.0000001, # Avoid division by zero or very small numbers
        (standard_error / abs(mean_value)) * 100,
        NA_real_
      )
    )
  
  ggplot(df_long, aes(x = as.numeric(year), y = relative_se)) +
    geom_line() +
    geom_point(alpha = 0.5) +
    labs(
      title = paste(title_prefix, "Relative Standard Error Over Time"),
      subtitle = "Standard error as percentage of mean value",
      x = "Year",
      y = "Relative Standard Error (%)"
    ) +
    theme_minimal()
}


countries <- c("Armenia", "Azerbaijan", "Belarus", "Estonia", "Georgia", "Kazakhstan", 
               "Kyrgyzstan", "Latvia", "Lithuania", "Moldova", "Russia", "Tajikistan", 
               "Turkmenistan", "Ukraine", "Uzbekistan", "Serbia", "Croatia", 
               "Bosnia and Herzegovina", "Slovenia", "Montenegro", "North Macedonia", 
               "Albania", "Bulgaria", "Romania", "Poland", "Germany", "Czechia", 
               "Slovakia", "Hungary")


plot_relative_se(df_child_mortality, "Child Mortality")
plot_relative_se(df_daily_income, "Daily Income")
plot_relative_se(df_life_expectancy, "Life Expectancy")
plot_relative_se(df_pop_growth, "Population Growth")
plot_relative_se(df_fertility, "Fertility Rate")
plot_relative_se(df_co2emissions, "CO2 Emissions")
plot_relative_se(df_population, "Population")
plot_relative_se(df_gdp_percap, "GDP Per Capita")
```






